name: CD - Deploy to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      auto_approve:
        description: 'Auto-approve deployment'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: latest

jobs:
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: dev
      url: ${{ steps.deploy.outputs.api_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Deploy to AWS
        id: deploy
        run: |
          chmod +x infrastructure/scripts/deploy.sh
          cd infrastructure
          ./scripts/deploy.sh dev ${{ env.AWS_REGION }} apply

          # Get outputs
          cd terraform/environments/dev
          API_URL=$(terraform output -raw api_gateway_url || echo "")
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Run smoke tests
        run: |
          API_URL="${{ steps.deploy.outputs.api_url }}"
          if [ -n "$API_URL" ]; then
            echo "Testing API health endpoint..."
            curl -f "$API_URL/health" || echo "Health check failed"
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to dev successful"
          else
            echo "❌ Deployment to dev failed"
          fi

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') ||
      startsWith(github.ref, 'refs/tags/')
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.api_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Deploy to AWS
        id: deploy
        run: |
          chmod +x infrastructure/scripts/deploy.sh
          cd infrastructure
          ./scripts/deploy.sh staging ${{ env.AWS_REGION }} apply

          cd terraform/environments/staging
          API_URL=$(terraform output -raw api_gateway_url || echo "")
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Run smoke tests
        run: |
          API_URL="${{ steps.deploy.outputs.api_url }}"
          if [ -n "$API_URL" ]; then
            echo "Testing API health endpoint..."
            curl -f "$API_URL/health" || echo "Health check failed"
          fi

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.api_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Terraform Plan
        run: |
          cd infrastructure/terraform/environments/production
          terraform init
          terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Deploy to AWS
        id: deploy
        if: github.event.inputs.auto_approve == 'true' || github.event_name != 'workflow_dispatch'
        run: |
          chmod +x infrastructure/scripts/deploy.sh
          cd infrastructure
          ./scripts/deploy.sh production ${{ env.AWS_REGION }} apply

          cd terraform/environments/production
          API_URL=$(terraform output -raw api_gateway_url || echo "")
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Run smoke tests
        run: |
          API_URL="${{ steps.deploy.outputs.api_url }}"
          if [ -n "$API_URL" ]; then
            echo "Testing API health endpoint..."
            curl -f "$API_URL/health" || echo "Health check failed"
          fi

      - name: Create deployment tag
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          TAG="production-$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG" -m "Production deployment $TAG"
          git push origin "$TAG"
